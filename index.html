<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì—¬í–‰ ì •ì‚° Â· ë‹¤í¬í…Œë§ˆ + êµ¬ê¸€ì‹œíŠ¸ ì—°ë™</title>
  <style>
    :root{--bg:#0b1022;--panel:#0f172a;--ink:#e5e7eb;--muted:#98a2b3;--line:#1f2937;--accent:#22c55e;--danger:#ef4444;--focus:#38bdf8}
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Malgun Gothic,sans-serif}
    body{margin:0;background:linear-gradient(120deg,#0b1022,#0f172a 60%);color:var(--ink)}
    a{color:var(--focus)}
    .wrap{max-width:1100px;margin:28px auto;padding:16px}
    .card{background:rgba(15,23,42,.92);border:1px solid var(--line);border-radius:18px;box-shadow:0 10px 35px rgba(0,0,0,.35);padding:18px}
    h1{margin:0 0 4px;font-size:28px}
    h2{margin:16px 0 8px;font-size:18px;color:#cbd5e1}
    .muted{color:var(--muted);font-size:13px}
    .grid{display:grid;gap:12px}
    .g2{grid-template-columns:repeat(2,1fr)}
    .g3{grid-template-columns:repeat(3,1fr)}
    .g4{grid-template-columns:repeat(4,1fr)}
    label{font-size:12px;color:#cbd5e1;margin-bottom:6px;display:block}
    input,select,button{background:#0b1220;border:1px solid #253041;color:var(--ink);padding:10px;border-radius:12px}
    input[type="number"]{text-align:right}
    input:focus,select:focus,button:focus{outline:none;border-color:var(--focus);box-shadow:0 0 0 3px rgba(56,189,248,.2)}
    button{cursor:pointer}
    .btn{height:40px;padding:0 14px;border-radius:12px;border:1px solid #334155;background:#0b1220}
    .btn.primary{background:var(--accent);border-color:#16a34a;color:#03210e;font-weight:700}
    .btn.ghost{background:transparent;border-color:#334155}
    .btn.danger{background:var(--danger);border-color:#b91c1c;color:#200}
    .row{display:flex;gap:10px;align-items:end;flex-wrap:wrap}
    .kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .kpi>div{background:#0b1220;border:1px solid #1e293b;border-radius:12px;padding:12px}
    .kpi strong{font-size:20px}
    .pill{display:inline-flex;align-items:center;gap:6px;font-size:12px;padding:4px 8px;border-radius:999px;background:#0b1220;border:1px solid #334155}
    .sep{height:1px;background:#1f2937;margin:14px 0}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{border-bottom:1px solid #1f2937;padding:8px;text-align:left}
    th{color:#cbd5e1;font-weight:600;position:sticky;top:0;background:rgba(15,23,42,.98)}
    .right{text-align:right}
    .group{margin:12px 0;border-left:3px solid #334155;padding-left:10px}
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .status{min-height:20px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>ğŸ§® ì—¬í–‰ ì •ì‚°</h1>
      <div class="muted">ë‹¤í¬ í…Œë§ˆÂ·ì¹´ë“œí˜• UIë¥¼ ìœ ì§€í•˜ë©´ì„œ <b>Google ìŠ¤í”„ë ˆë“œì‹œíŠ¸</b>ì— ë°ì´í„°ë¥¼ ì €ì¥/ê³µìœ í•©ë‹ˆë‹¤. (URLë§Œ ì•Œë©´ ëª¨ë‘ê°€ ê°™ì€ ë°ì´í„° ë³´ê¸°/ì¶”ê°€ ê°€ëŠ¥)</div>

      <h2>â‘  ê¸°ë³¸ ì„¤ì •</h2>
      <div class="grid g4">
        <div>
          <label>ì¸ì›ìˆ˜ (ìµœëŒ€ 10)</label>
          <select id="people"></select>
        </div>
        <div>
          <label>ìˆ™ë°•ì¼ìˆ˜</label>
          <select id="nights">
            <option value="1">1ë°•</option>
            <option value="2">2ë°•</option>
            <option value="3">3ë°•</option>
          </select>
        </div>
        <div>
          <label>ì—¬í–‰ ì‹œì‘ì¼</label>
          <input id="tripStart" type="date" />
        </div>
        <div>
          <label>ì—¬í–‰ ì œëª©</label>
          <input id="tripTitle" type="text" placeholder="ì˜ˆ) 9ì›” ì œì£¼ ê°€ì¡±ì—¬í–‰" />
        </div>
      </div>

      <div class="sep"></div>
      <h2>â‘¡ ì§€ì¶œ í•­ëª© ì¶”ê°€</h2>
      <div class="grid g4">
        <div>
          <label>ë‚ ì§œ</label>
          <input id="date" type="date" />
        </div>
        <div>
          <label>ì¥ì†Œ</label>
          <input id="place" type="text" placeholder="ì˜ˆ) ì„œê·€í¬, ê´‘ì•ˆë¦¬" />
        </div>
        <div>
          <label>ë‚´ìš©</label>
          <input id="desc" type="text" placeholder="ì˜ˆ) ì ì‹¬, ìˆ™ë°•, ì£¼ìœ " />
        </div>
        <div>
          <label>ê¸ˆì•¡(ì›)</label>
          <input id="amount" type="number" min="0" step="1" placeholder="0" />
        </div>
        <div class="g4" style="grid-column:1/-1">
          <label>ë¹„ê³ </label>
          <div class="toolbar">
            <input id="note" type="text" placeholder="ì„ ê²°ì œ/í˜„ê¸ˆ ë“±" style="flex:1" />
            <button class="btn primary" id="addBtn">í•­ëª© ì¶”ê°€</button>
          </div>
        </div>
      </div>

      <div class="sep"></div>
      <div class="kpi">
        <div><div class="muted">ì´ ì§€ì¶œ</div><strong id="sumTotal">0</strong><div class="muted">ì›</div></div>
        <div><div class="muted">1ì¸ë‹¹ ë¶€ë‹´</div><strong id="perHead">0</strong><div class="muted">ì›</div></div>
        <div><div class="muted">í•­ëª© ìˆ˜</div><strong id="itemCount">0</strong><div class="muted">ê±´</div></div>
      </div>

      <div class="sep"></div>
      <div class="toolbar">
        <input id="filterText" type="text" placeholder="ë‚´ìš©/ì¥ì†Œ ê²€ìƒ‰" style="flex:1" />
        <button class="btn ghost" id="refreshBtn">ìƒˆë¡œê³ ì¹¨</button>
        <span class="muted status" id="status"></span>
      </div>

      <div class="sep"></div>
      <h2>â‘¢ ë‚´ì—­</h2>
      <div id="list"></div>
    </div>
  </div>

<script>
// ====== ì„¤ì • (ë³¸ì¸ Apps Script ì›¹ì•± URL) ======
const API_URL = 'https://script.google.com/macros/s/AKfycbyZtdeXB3U_xd5pEEEyUwipXpQOZdHIiRyvso3n4NwpaL5u1EPVVGs-CaXQmWRYrwMoqQ/exec';
// const WRITE_TOKEN = 'ì„ íƒ: í† í° ë³´í˜¸ì‹œ ì—¬ê¸°ì—';

// ====== ë„ìš°ë¯¸ ======
const $ = (sel)=>document.querySelector(sel);
const state = {
  settings: { people: 2, nights: 1, tripStart: '', tripTitle: '' },
  items: [],
  filtered: []
};
function money(n){ return Number(n||0).toLocaleString('ko-KR'); }
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' }[c])); }
function setStatus(msg){ $('#status').textContent = msg||''; }

// ====== ì„œë²„ í†µì‹  ======
async function fetchItems(){
  setStatus('ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦');
  try{
    const res = await fetch(API_URL, { method:'GET' });
    if(!res.ok) throw new Error(`GET ${res.status}`);
    const data = await res.json();
    setStatus('');
    return Array.isArray(data)? data: [];
  }catch(err){
    console.error('[fetchItems] ì‹¤íŒ¨', err);
    alert('ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: '+err.message);
    setStatus('ì˜¤ë¥˜');
    return [];
  }
}

async function postItem(item){
  setStatus('ì €ì¥ ì¤‘â€¦');
  try{
    const payload = { ...item /*, token: WRITE_TOKEN*/ };
    const res = await fetch(API_URL, {
      method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
    });
    if(!res.ok){ const t = await res.text(); throw new Error(`POST ${res.status}: ${t}`); }
    setStatus('ì €ì¥ ì™„ë£Œ');
  }catch(err){
    console.error('[postItem] ì‹¤íŒ¨', err);
    setStatus('ì˜¤ë¥˜');
    throw err;
  }
}

// ====== ë Œë”ë§ ======
function groupByDatePlace(items){
  const map = new Map();
  items.forEach(it=>{
    const key = `${it.date||''}__${it.place||''}`;
    if(!map.has(key)) map.set(key, { date: it.date||'', place: it.place||'', rows: [], sum:0 });
    const g = map.get(key); g.rows.push(it); g.sum += Number(it.amount||0);
  });
  return Array.from(map.values()).sort((a,b)=> (a.date||'').localeCompare(b.date||''));
}

function renderKPIs(){
  const people = Number(state.settings.people)||1;
  const total = state.filtered.reduce((s,it)=> s + Number(it.amount||0), 0);
  $('#sumTotal').textContent = money(total);
  $('#perHead').textContent = money(Math.round(total/people));
  $('#itemCount').textContent = state.filtered.length;
}

function renderList(){
  const groups = groupByDatePlace(state.filtered);
  const $list = $('#list');
  if(groups.length===0){ $list.innerHTML = '<p class="muted">ì¡°ê±´ì— ë§ëŠ” í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</p>'; return; }
  $list.innerHTML = groups.map(g=>`
    <div class="group">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
        <div>
          <span class="pill">ğŸ“… ${escapeHtml(g.date)}</span>
          ${g.place?`<span class="pill">ğŸ“ ${escapeHtml(g.place)}</span>`:''}
        </div>
        <div class="pill">ê·¸ë£¹ í•©ê³„: <b>${money(g.sum)}</b>ì› Â· 1ì¸ <b>${money(Math.round(g.sum/Number(state.settings.people||1)))}</b>ì›</div>
      </div>
      <table>
        <thead><tr>
          <th style="width:40%">ë‚´ìš©</th>
          <th class="right" style="width:15%">ê¸ˆì•¡</th>
          <th class="right" style="width:15%">1ì¸ ì •ì‚°</th>
          <th style="width:25%">ë¹„ê³ </th>
        </tr></thead>
        <tbody>
          ${g.rows.map(r=>`
            <tr>
              <td>${escapeHtml(r.desc)}</td>
              <td class="right">${money(r.amount)}</td>
              <td class="right">${money(Math.round(Number(r.amount||0)/Number(state.settings.people||1)))}</td>
              <td>${escapeHtml(r.note)}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
  `).join('');
}

function applyFilter(){
  const q = ($('#filterText').value||'').trim().toLowerCase();
  state.filtered = !q ? [...state.items] : state.items.filter(it=>{
    return (it.desc||'').toLowerCase().includes(q) || (it.place||'').toLowerCase().includes(q);
  });
  renderKPIs();
  renderList();
}

// ====== ì´ë²¤íŠ¸ & ì´ˆê¸°í™” ======
function initUI(){
  // ì¸ì›ìˆ˜ ì˜µì…˜
  $('#people').innerHTML = Array.from({length:10},(_,i)=>`<option value="${i+1}">${i+1}ëª…</option>`).join('');

  // ê¸°ë³¸ ë‚ ì§œ
  const today = new Date().toISOString().slice(0,10);
  $('#date').value = today;

  // ì„¤ì • ë³€í™” ì €ì¥(ë¡œì»¬ ì„¤ì •ë§Œ ì €ì¥)
  ['people','nights','tripStart','tripTitle'].forEach(id=>{
    $('#'+id).addEventListener('change', e=>{
      const v = (id==='people'||id==='nights') ? Number(e.target.value) : e.target.value;
      state.settings[id] = v; renderKPIs(); renderList();
    });
  });

  // ë²„íŠ¼ë“¤
  $('#addBtn').addEventListener('click', onAdd);
  $('#refreshBtn').addEventListener('click', refreshFromServer);
  $('#filterText').addEventListener('input', applyFilter);
}

async function refreshFromServer(){
  const data = await fetchItems();
  state.items = data; state.filtered = [...data];
  applyFilter();
}

async function onAdd(){
  const date = $('#date').value;
  const place = $('#place').value.trim();
  const desc = $('#desc').value.trim();
  const amountRaw = $('#amount').value;
  const note = $('#note').value.trim();

  if(!date || !desc){ alert('ë‚ ì§œì™€ ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); return; }
  const amount = Number(amountRaw);
  if(isNaN(amount)){ alert('ê¸ˆì•¡ì€ ìˆ«ìë¡œ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); return; }

  try{
    await postItem({ date, place, desc, amount, note });
    // ì…ë ¥ì°½ ì¼ë¶€ ì´ˆê¸°í™”
    $('#desc').value=''; $('#amount').value=''; $('#note').value='';
    await refreshFromServer();
  }catch(err){
    alert('ì¶”ê°€ ì‹¤íŒ¨: '+err.message+'\nApps Script ë°°í¬ ê¶Œí•œê³¼ ì‹œíŠ¸ íƒ­ ì´ë¦„ì„ í™•ì¸í•˜ì„¸ìš”.');
  }
}

// ë¶€íŒ…
window.addEventListener('DOMContentLoaded', async ()=>{
  initUI();
  await refreshFromServer();
});
</script>
</body>
</html>
