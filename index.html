<!-- 요약: API URL는 본인 웹앱 URL, addItem 검증완화, 오류표시 강화 -->
<!-- (이미 URL 주신 그대로 사용) -->
<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbyZtdeXB3U_xd5pEEEyUwipXpQOZdHIiRyvso3n4NwpaL5u1EPVVGs-CaXQmWRYrwMoqQ/exec';

const $ = (s)=>document.querySelector(s);

// 인원수 옵션
const peopleSelect = $('#people');
if (peopleSelect) {
  peopleSelect.innerHTML = Array.from({length:10},(_,i)=>`<option value="${i+1}">${i+1}명</option>`).join('');
}

// 기본 날짜
const today = new Date().toISOString().slice(0,10);
const dateInput = $('#date');
if (dateInput) dateInput.value = today;

function formatMoney(n){ return Number(n||0).toLocaleString('ko-KR'); }

async function fetchItems(){
  try{
    const res = await fetch(API_URL, { method:'GET' });
    if(!res.ok) throw new Error(`GET ${res.status} ${res.statusText}`);
    return await res.json();
  }catch(err){
    console.error('[fetchItems] 실패:', err);
    alert('목록 불러오기 실패: ' + err.message);
    return [];
  }
}

async function postItem(item){
  try{
    const res = await fetch(API_URL, {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify(item)
    });
    // Apps Script가 JSON 반환 안해도 OK로 간주
    if(!res.ok){
      const text = await res.text();
      throw new Error(`POST ${res.status}: ${text}`);
    }
    // 가능하면 응답 JSON 파싱
    try { 
      const data = await res.json(); 
      if(data && data.error) throw new Error(data.error);
    } catch(_) { /* 응답이 비JSON이어도 무시 */ }
  }catch(err){
    console.error('[postItem] 실패:', err);
    throw err;
  }
}

async function render(){
  const items = await fetchItems();
  const tbody = $('#list');
  if(!tbody) return;
  if(!items.length){
    tbody.innerHTML = '<tr><td colspan="5">데이터 없음</td></tr>';
    return;
  }
  tbody.innerHTML = items.map(r=>`
    <tr>
      <td>${r.date||''}</td>
      <td>${r.place||''}</td>
      <td>${r.desc||''}</td>
      <td class="right">${formatMoney(r.amount)}</td>
      <td>${r.note||''}</td>
    </tr>
  `).join('');
}

async function addItem(){
  const date = $('#date')?.value;
  const place = $('#place')?.value?.trim() || '';
  const desc = $('#desc')?.value?.trim();
  const amountRaw = $('#amount')?.value;
  const note = $('#note')?.value?.trim() || '';

  // 검증: 날짜/내용/금액(숫자) — 0원도 허용
  if(!date || !desc){
    alert('날짜와 내용을 입력해 주세요.');
    return;
  }
  const amount = Number(amountRaw);
  if(isNaN(amount)){
    alert('금액에 숫자를 입력해 주세요.');
    return;
  }

  try{
    await postItem({ date, place, desc, amount, note });
    // 입력창 초기화
    $('#desc').value=''; $('#amount').value=''; $('#note').value='';
    await render();
  }catch(err){
    alert('추가 실패: ' + err.message + '\n콘솔(F12)에서 상세 오류를 확인하세요.');
  }
}

$('#addBtn')?.addEventListener('click', addItem);

// 첫 렌더
render();
</script>
